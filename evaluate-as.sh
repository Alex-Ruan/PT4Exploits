#!/bin/bash

SRC_DIR=$PWD/utils
cd $PWD
if [ $# -ne 2 ]; then
    echo "Usage: evaluate.sh [eval_dir] [data_dir]"
    echo "[eval_dir]: is the eval dir"
    echo "[data_dir]: is the dataset dir, either data_shell_gen or data_shell_gen_IP"
    echo "data_dir Options:"
    echo "0 - used for raw corpus token counts"
    echo "1 - Preprocessing without the Intent Parser (IP)"
    echo "2 - Preprocessing with the Intent Parser (IP)"
    exit 1
fi;
function echo_time() {
        date +"%Y-%m-%d %H:%M:%S.%6N  $*"
}

function select_dataset() {
  if [ $1 -eq 0 ]; then
		data_dir="data_shell_gen_p-noIP";
		echo "data_shell_gen_p-noIP selected";
	elif [ $1 -eq 1 ]; then
		data_dir="data_shell_gen";
		echo "data_shell_gen selected(raw)";
	elif [ $1 -eq 2 ]; then
		data_dir="data_shell_gen_IP";
		echo "data_shell_gen_IP selected";
	else
		echo "ERROR: Wrong machine";
	        echo "Usage: evaluate.sh [eval_dir] [data_dir]"
		echo "data_dir:0 is p-noIP, 1 is noIP, 2 is with IP."
		exit 0;
	fi
}

dataset_str=decoder
select_dataset $2;

output_dir='eval/'$1
echo $output_dir

python $SRC_DIR/eval_prep.py $1

python $SRC_DIR/seq2seq_output_to_code.py $1 ${data_dir}/$dataset_str-test.json.seq2seq ${output_dir}/${dataset_str}_test_output.json ${dataset_str}


cp ${data_dir}/${dataset_str}-test.json ${output_dir}/${dataset_str}_test_gold.json # gold文件直接靠复制
python $SRC_DIR/codegen_eval.py --strip_ref_metadata --input_ref ${output_dir}/${dataset_str}_test_gold.json --input_hyp ${output_dir}/${dataset_str}_test_output.json
